image: "ruby:2.6.3"

stages:
  - build
  - rubocop
  - unit
  - feature

variables:
  RAILS_ENV: "test"
  BUNDLE_PATH: vendor/bundle

.default-cache: &default-cache
  cache:
    untracked: true
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - vendor/
      - public/

build:
  <<: *default-cache
  stage: build
  script:
    - ruby -v
    - which ruby
    - gem install bundler  -v 2.1.2 --no-document
    - bundle config set without 'production'
    - bundle check || bundle install --jobs $(nproc) --path=vendor

rubocop:
  <<: *default-cache
  stage: rubocop
  script:
    - gem install bundler  -v 2.1.2 --no-document
    - bundle config set without 'production'
    - bundle check || bundle install --jobs $(nproc) --path=vendor
    - bundle exec rubocop --require rubocop-performance

unit_rspec:
  <<: *default-cache
  stage: unit
  script:
    - apt-get update -qq && apt-get install -y -qq sqlite3 libsqlite3-dev
    - curl --silent --show-error https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add
    - echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
    - curl -sL https://deb.nodesource.com/setup_10.x | bash -
    - apt-get update
    - apt-get install -y nodejs yarn
    - gem install bundler  -v 2.1.2 --no-document
    - bundle config set without 'production'
    - bundle check || bundle install --jobs $(nproc) --path=vendor
    - cp config/database.yml.sample config/database.yml
    - bundle exec rake db:create db:schema:load
    - yarn install
    - RAILS_ENV=test ./bin/rails webpacker:compile
    - rspec spec --exclude-pattern "**/features/**/*_spec.rb"
  artifacts:
    paths:
      - coverage/

feature_rspec:
  <<: *default-cache
  services:
    - selenium/standalone-chrome:latest
  stage: feature
  script:
    - apt-get update -qq && apt-get install -y -qq sqlite3 libsqlite3-dev
    - curl --silent --show-error https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add
    - echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
    - curl -sL https://deb.nodesource.com/setup_10.x | bash -
    - apt-get update
    - apt-get install -y nodejs yarn
    - gem install bundler  -v 2.1.2 --no-document
    - bundle config set without 'production'
    - bundle check || bundle install --jobs $(nproc) --path=vendor
    - cp config/database.yml.sample config/database.yml
    - bundle exec rake db:create db:schema:load
    - apt-get install -y chromium
    - export selenium_remote_url="http://selenium__standalone-chrome:4444/wd/hub/"
    - yarn install
    - RAILS_ENV=test ./bin/rails webpacker:compile
    - rspec spec --tag type:feature
